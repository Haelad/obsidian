### `annotate()`

–ú–µ—Ç–æ–¥ `annotate()` –≤ Django –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è **–¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤—ã—á–∏—Å–ª—è–µ–º—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π** (–∞–Ω–Ω–æ—Ç–∞—Ü–∏–π) –∫ –∫–∞–∂–¥–æ–º—É –æ–±—ä–µ–∫—Ç—É QuerySet.  
–û–Ω –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è, –∫–æ—Ç–æ—Ä—ã–µ —Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è **–Ω–∞ —É—Ä–æ–≤–Ω–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö**, –∞ –Ω–µ –≤ Python.

---

#### üìñ –°–∏–Ω—Ç–∞–∫—Å–∏—Å


```python
Model.objects.annotate(<–∏–º—è_–Ω–æ–≤–æ–≥–æ_–ø–æ–ª—è>=<–≤—ã—Ä–∞–∂–µ–Ω–∏–µ>)
```


–ê–Ω–Ω–æ—Ç–∞—Ü–∏—è –º–æ–∂–µ—Ç –≤–∫–ª—é—á–∞—Ç—å:

- –∞–≥—Ä–µ–≥–∞—Ç–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (`Count`, `Sum`, `Avg`, `Max`, `Min`);
- –∞—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–∏–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è (`F`-–æ–±—ä–µ–∫—Ç—ã);
- —É—Å–ª–æ–≤–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è (`Case`, `When`);
- –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ —ç—Ç–∏—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤.


---

#### üí° –ü—Ä–∏–º–µ—Ä—ã

|–¶–µ–ª—å|–ü—Ä–∏–º–µ—Ä|–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π|
|---|---|---|
|–ü–æ–¥—Å—á–∏—Ç–∞—Ç—å —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏|`Author.objects.annotate(num_books=Count('books'))`|–ê–Ω–∞–ª–æ–≥ SQL `COUNT()`|
|–ù–∞–π—Ç–∏ —Å—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ|`Book.objects.annotate(avg_price=Avg('price'))`|–ê–Ω–∞–ª–æ–≥ SQL `AVG()`|
|–°–∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞—Ç—å –≤—ã—á–∏—Å–ª–µ–Ω–∏—è|`Book.objects.annotate(final=F('price') * 1.2)`|–í—ã—á–∏—Å–ª—è–µ–º–æ–µ –ø–æ–ª–µ|
|–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∞–≥—Ä–µ–≥–∞—Ç–∞–º|`.filter(num_books__gt=3)`|–ê–Ω–∞–ª–æ–≥ `HAVING COUNT()>3`|
|–°—É–º–º–∞ –ø–æ —Å–≤—è–∑—è–º|`Author.objects.annotate(total_price=Sum('books__price'))`|–ê–Ω–∞–ª–æ–≥ `SUM()` –ø–æ JOIN‚Äô—É|

#### ‚öôÔ∏è –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç `annotate()`

- **–ù–µ —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å**, –∞ **—Ä–∞—Å—à–∏—Ä—è–µ—Ç —Ç–µ–∫—É—â–∏–π**.

- –í—Å–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è **–≤–Ω—É—Ç—Ä–∏ SQL-–∑–∞–ø—Ä–æ—Å–∞**.

- –≠—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç **–≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö**, –±–µ–∑ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ –ø–∞–º—è—Ç—å Python.


–ü–æ–¥—Ä–æ–±–Ω–µ–µ —Å–º. [[queryset_internal_vs_external]] ‚Äî –≥–¥–µ –æ–±—ä—è—Å–Ω—è–µ—Ç—Å—è, –∫–∞–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ –ë–î, –∞ –∫–∞–∫–∏–µ –≤ Python.

#### –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `annotate()`

–ò—Å–ø–æ–ª—å–∑—É–π –µ–≥–æ, –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–æ:

- –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ (—Å—É–º–º—ã, —Å—Ä–µ–¥–Ω–∏–µ, –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞);
- —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ –≤—ã—á–∏—Å–ª–µ–Ω–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏—è–º;
- —É–º–µ–Ω—å—à–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤;
- –≤—ã–ø–æ–ª–Ω—è—Ç—å –∞—Ä–∏—Ñ–º–µ—Ç–∏–∫—É –∏ —É—Å–ª–æ–≤–∏—è –ø—Ä—è–º–æ –Ω–∞ —É—Ä–æ–≤–Ω–µ SQL.


```python
from django.db.models import Sum

authors = Author.objects.annotate(
    total_price=Sum('books__price')
).filter(total_price__gt=1000)
```
> –≠—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å —Å–æ–∑–¥–∞—ë—Ç –ø–æ–ª–µ total_price –ø—Ä—è–º–æ –≤ SQL –∏ —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç –∞–≤—Ç–æ—Ä–æ–≤, —É –∫–æ—Ç–æ—Ä—ã—Ö –æ–±—â–∞—è —Ü–µ–Ω–∞ –∫–Ω–∏–≥ > 1000.


üìé –°–º. —Ç–∞–∫–∂–µ:

- [[queryset_internal_vs_external]] ‚Äî –≥–¥–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –æ–ø–µ—Ä–∞—Ü–∏–∏ (–≤ –ë–î –∏–ª–∏ –≤ Python)
- [[F_Case_When]] ‚Äî –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≤—ã—á–∏—Å–ª–µ–Ω–∏–π –≤ `annotate`